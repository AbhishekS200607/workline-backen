<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Workline</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="landscape-bg"></div>
    
    <header class="header">
        <div class="logo">
            <div class="logo-icon">W</div>
            <span>WORKLINE</span>
        </div>
        <nav class="nav">
            <a href="dashboard-worker.html">DASHBOARD</a>
            <a href="worker-bookings.html" style="color: #F59E0B;">MY BOOKINGS</a>
            <a href="worker-earnings.html">EARNINGS</a>
        </nav>
        <div class="header-right">
            <button onclick="window.location.href='dashboard-worker.html'" style="background: rgba(255,255,255,0.1); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; backdrop-filter: blur(10px);">Back to Dashboard</button>
        </div>
    </header>

    <main style="margin-top: 80px; background: #F8FAFC; min-height: 100vh; padding: 2rem;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="margin-bottom: 2rem;">
                <h1 style="color: #1A202C; font-size: 2rem; margin-bottom: 0.5rem;">My Bookings</h1>
                <p style="color: #718096;">Manage your service bookings and customer requests</p>
            </div>

            <!-- Filter Tabs -->
            <div style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
                <div style="display: flex; gap: 1rem;">
                    <button onclick="filterBookings('all')" id="filter-all" style="padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; background: #8B7355; color: white;">All Bookings</button>
                    <button onclick="filterBookings('PENDING')" id="filter-pending" style="padding: 0.75rem 1.5rem; border: 1px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 500; background: white; color: #374151;">Pending</button>
                    <button onclick="filterBookings('CONFIRMED')" id="filter-confirmed" style="padding: 0.75rem 1.5rem; border: 1px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 500; background: white; color: #374151;">Confirmed</button>
                    <button onclick="filterBookings('COMPLETED')" id="filter-completed" style="padding: 0.75rem 1.5rem; border: 1px solid #D1D5DB; border-radius: 8px; cursor: pointer; font-weight: 500; background: white; color: #374151;">Completed</button>
                </div>
            </div>

            <!-- Bookings List -->
            <div id="bookingsList">
                <div style="text-align: center; padding: 3rem; color: #718096;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                    <p>Loading your bookings...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script src="js/success-animations.js"></script>
    <script>
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.userId || user.userType !== 'WORKER') {
            window.location.href = 'worker-auth.html';
        }

        let allBookings = [];
        let currentFilter = 'all';

        // Load bookings on page load
        loadBookings();

        async function loadBookings() {
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/worker/${user.userId}`);
                if (response.ok) {
                    allBookings = await response.json();
                    displayBookings(allBookings);
                } else {
                    document.getElementById('bookingsList').innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #718096;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                            <p>No bookings found</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('bookingsList').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #EF4444;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
                        <p>Error loading bookings</p>
                    </div>
                `;
            }
        }

        function filterBookings(status) {
            currentFilter = status;
            
            // Update button styles
            document.querySelectorAll('[id^="filter-"]').forEach(btn => {
                btn.style.background = 'white';
                btn.style.color = '#374151';
                btn.style.border = '1px solid #D1D5DB';
            });
            document.getElementById(`filter-${status}`).style.background = '#8B7355';
            document.getElementById(`filter-${status}`).style.color = 'white';
            document.getElementById(`filter-${status}`).style.border = 'none';

            // Filter and display bookings
            const filteredBookings = status === 'all' ? allBookings : allBookings.filter(b => b.status === status);
            displayBookings(filteredBookings);
        }

        function displayBookings(bookings) {
            const container = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #718096;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìã</div>
                        <p>No bookings found for ${currentFilter === 'all' ? 'any status' : currentFilter.toLowerCase()}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = bookings.map(booking => `
                <div style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #E2E8F0;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center;">
                            <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #8B7355, #6B5B47); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                                <span style="color: white; font-weight: bold; font-size: 1.2rem;">${booking.user.fullName.charAt(0)}</span>
                            </div>
                            <div>
                                <h3 style="color: #1A202C; margin-bottom: 0.25rem; font-size: 1.1rem;">${booking.user.fullName}</h3>
                                <p style="color: #718096; font-size: 0.9rem; margin-bottom: 0.25rem;">üìß ${booking.user.email}</p>
                                <p style="color: #718096; font-size: 0.9rem;">üìû ${booking.user.phone}</p>
                            </div>
                        </div>
                        <span style="
                            padding: 0.5rem 1rem; 
                            border-radius: 20px; 
                            font-size: 0.8rem; 
                            font-weight: 600;
                            background: ${getStatusColor(booking.status).bg};
                            color: ${getStatusColor(booking.status).text};
                        ">${booking.status}</span>
                    </div>
                    
                    <div style="background: #F8FAFC; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <p style="color: #6B7280; font-size: 0.8rem; margin-bottom: 0.25rem;">üìÖ Booking Date</p>
                                <p style="color: #1A202C; font-weight: 500;">${new Date(booking.bookingDate).toLocaleDateString()}</p>
                            </div>
                            <div>
                                <p style="color: #6B7280; font-size: 0.8rem; margin-bottom: 0.25rem;">üí∞ Amount</p>
                                <p style="color: #1A202C; font-weight: 500;">‚Çπ${booking.totalAmount || 0}</p>
                            </div>
                            <div>
                                <p style="color: #6B7280; font-size: 0.8rem; margin-bottom: 0.25rem;">üìç Location</p>
                                <p style="color: #1A202C; font-weight: 500;">${booking.user.address || 'Not provided'}</p>
                            </div>
                        </div>
                    </div>
                    
                    ${booking.status === 'PENDING' ? `
                        <div style="display: flex; gap: 1rem;">
                            <button onclick="updateBookingStatus(${booking.id}, 'CONFIRMED')" style="flex: 1; background: #10B981; color: white; padding: 0.75rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Accept Booking</button>
                            <button onclick="updateBookingStatus(${booking.id}, 'CANCELLED')" style="flex: 1; background: #EF4444; color: white; padding: 0.75rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Decline</button>
                        </div>
                    ` : booking.status === 'CONFIRMED' ? `
                        <button onclick="updateBookingStatus(${booking.id}, 'COMPLETED')" style="width: 100%; background: #8B7355; color: white; padding: 0.75rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500;">Mark as Completed</button>
                    ` : ''}
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'PENDING': { bg: '#FEF3C7', text: '#92400E' },
                'CONFIRMED': { bg: '#D1FAE5', text: '#065F46' },
                'COMPLETED': { bg: '#DBEAFE', text: '#1E40AF' },
                'CANCELLED': { bg: '#FEE2E2', text: '#991B1B' }
            };
            return colors[status] || { bg: '#F3F4F6', text: '#374151' };
        }

        async function updateBookingStatus(bookingId, newStatus) {
            // Show confirmation for cancellation
            if (newStatus === 'CANCELLED') {
                const booking = allBookings.find(b => b.id === bookingId);
                const refundMessage = booking && booking.paymentMethod !== 'cash' && booking.totalAmount > 0 
                    ? `\n\nRefund of ‚Çπ${booking.totalAmount} will be added to customer's wallet.`
                    : '';
                    
                if (!confirm(`Are you sure you want to cancel this booking?${refundMessage}`)) {
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    // Show success animation based on status
                    SuccessAnimations.bookingStatusUpdated(newStatus);
                    
                    // Show additional message for cancellation with refund
                    if (newStatus === 'CANCELLED') {
                        const booking = allBookings.find(b => b.id === bookingId);
                        if (booking && booking.paymentMethod !== 'cash' && booking.totalAmount > 0) {
                            setTimeout(() => {
                                SuccessAnimations.showSuccessToast(`üí∞ Refund of ‚Çπ${booking.totalAmount} processed to customer's wallet.`);
                            }, 1000);
                        }
                    }
                    
                    // Show payment success for completed bookings
                    if (newStatus === 'COMPLETED') {
                        const booking = allBookings.find(b => b.id === bookingId);
                        if (booking && booking.totalAmount > 0) {
                            setTimeout(() => {
                                SuccessAnimations.showSuccessToast(`üí≥ Payment of ‚Çπ${booking.totalAmount} added to your earnings!`, 'payment');
                            }, 1000);
                        }
                    }
                    
                    loadBookings(); // Reload bookings
                } else {
                    alert('Failed to update booking status');
                }
            } catch (error) {
                console.error('Error updating booking:', error);
                alert('Network error. Please try again.');
            }
        }
    </script>
</body>
</html>